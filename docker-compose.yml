version: '3.8'

services:
  # Jupyter Notebook Service
  jupyter:
    build:
      context: .
      dockerfile: docker/Dockerfile.jupyter
    container_name: ml-practice-jupyter
    ports:
      - "8888:8888"
    volumes:
      - ./code_folder:/home/jovyan/work/code_folder
      - ./notebooks:/home/jovyan/work/notebooks
      - ./data:/home/jovyan/work/data
      - ./models:/home/jovyan/work/models
      - jupyter-config:/home/jovyan/.jupyter
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - GRANT_SUDO=yes
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-ml_practice}
      - POSTGRES_USER=${POSTGRES_USER:-mluser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mlpassword}
    env_file:
      - .env
    networks:
      - ml-network
    depends_on:
      - postgres
    restart: unless-stopped
    user: root
    command: start-notebook.sh --NotebookApp.token='${JUPYTER_TOKEN:-jupyter}' --NotebookApp.password=''

  # PostgreSQL Database Service
  postgres:
    image: postgres:15-alpine
    container_name: ml-practice-postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./sql/init:/docker-entrypoint-initdb.d
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ml_practice}
      - POSTGRES_USER=${POSTGRES_USER:-mluser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mlpassword}
    env_file:
      - .env
    networks:
      - ml-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mluser}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PgAdmin (Optional - for database management UI)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ml-practice-pgadmin
    ports:
      - "5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@mlpractice.local}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - ml-network
    depends_on:
      - postgres
    restart: unless-stopped
    profiles:
      - tools

  # MLflow Tracking Server
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.9.2
    container_name: ml-practice-mlflow
    ports:
      - "5000:5000"
    volumes:
      - mlflow-data:/mlflow
      - ./models:/mlflow/models
    environment:
      - MLFLOW_BACKEND_STORE_URI=postgresql://${POSTGRES_USER:-mluser}:${POSTGRES_PASSWORD:-mlpassword}@postgres:5432/${POSTGRES_DB:-ml_practice}
      - MLFLOW_DEFAULT_ARTIFACT_ROOT=/mlflow/artifacts
    env_file:
      - .env
    networks:
      - ml-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    command: >
      mlflow server
      --backend-store-uri postgresql://${POSTGRES_USER:-mluser}:${POSTGRES_PASSWORD:-mlpassword}@postgres:5432/${POSTGRES_DB:-ml_practice}
      --default-artifact-root /mlflow/artifacts
      --host 0.0.0.0
      --port 5000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  ml-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  pgadmin-data:
    driver: local
  jupyter-config:
    driver: local
  mlflow-data:
    driver: local
